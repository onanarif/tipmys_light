{# templates/qbank/question_form.html #}
{% extends "inc/base.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Soruyu Düzenle{% else %}Yeni Soru{% endif %}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">{% if form.instance.pk %}Soruyu Düzenle{% else %}Yeni Soru{% endif %}</h2>
    <a class="btn btn-secondary" href="{% url 'qbank:question_list' %}">Listeye Dön</a>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}
      {% if form.errors %}
        <div class="alert alert-danger">
          <strong>Formda hatalar var.</strong>
          <ul class="mb-0">
            {% for field in form %}
              {% for err in field.errors %}
                <li><strong>{{ field.label }}:</strong> {{ err }}</li>
              {% endfor %}
            {% endfor %}
            {% for err in form.non_field_errors %}
              <li>{{ err }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

    <!-- Temel Bilgiler -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-bold">Temel Bilgiler</div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label">Ders (CourseMaster)</label>
          {{ form.master }}
          {% if form.master.errors %}<div class="text-danger small">{{ form.master.errors }}</div>{% endif %}
        </div>

        <div class="col-md-3">
          <label class="form-label">Ders (görüntü)</label>
          {{ form.course_display }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Öğretim Üyesi</label>
          {{ form.lecturer_display }}
        </div>

        <div class="col-md-6">
          <label class="form-label">Soru Adı</label>
          {{ form.name }}
          {% if form.name.errors %}<div class="text-danger small">{{ form.name.errors }}</div>{% endif %}
        </div>

        <div class="col-md-3">
          <label class="form-label">Tür</label>
          {{ form.type }}
          {% if form.type.errors %}<div class="text-danger small">{{ form.type.errors }}</div>{% endif %}
        </div>

        <div class="col-md-3">
          <label class="form-label d-block">Aktif</label>
          {{ form.active }}
        </div>

        <div class="col-12">
          <label class="form-label">Soru Metni</label>
          {{ form.question_text }}
          {% if form.question_text.errors %}<div class="text-danger small">{{ form.question_text.errors }}</div>{% endif %}
        </div>

      </div>
    </div>

    <!-- Şıklar (A–E) + Doğru Cevap (göster ve düzenlenebilir) -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-bold">Şıklar (A–E)</div>
      <div class="card-body row g-3">
        <div class="col-md-8">
          <label class="form-label">A</label>
          {{ form.answer_1_text }}
        </div>


        <div class="col-md-8">
          <label class="form-label">B</label>
          {{ form.answer_2_text }}
        </div>


        <div class="col-md-8">
          <label class="form-label">C</label>
          {{ form.answer_3_text }}
        </div>


        <div class="col-md-8">
          <label class="form-label">D</label>
          {{ form.answer_4_text }}
        </div>


        <div class="col-md-8">
          <label class="form-label">E</label>
          {{ form.answer_5_text }}
        </div>


        <!-- Doğru cevap: ZORUNLU ve DÜZENLENEBİLİR -->
        <div class="col-md-4">
          <label class="form-label">Doğru cevap</label>
          {{ form.correct_answer }}
          {% if form.correct_answer.errors %}<div class="text-danger small">{{ form.correct_answer.errors }}</div>{% endif %}
          <div class="form-text">A–E arasından seçiniz. Kaydederken tek-şık politikası korunur.</div>
        </div>
      </div>
    </div>

    <!-- Geri Bildirim Metinleri -->
    <div class="card shadow-sm mb-3">
      <div class="card-header fw-bold">Geri Bildirim Metinleri</div>
      <div class="card-body row g-3">
        <div class="col-md-12">
          <label class="form-label">Doğru</label>
          {{ form.correct_feedback }}
        </div>

      </div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">Kaydet</button>
      <a class="btn btn-outline-secondary" href="{% url 'qbank:question_list' %}">Vazgeç</a>
    </div>
  </form>
</div>

<!-- Select2 assets (for master/type) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
<script>
(function(){
  function widthResolver(){ return '100%'; }
  $('.select2').select2({
    theme: 'bootstrap-5',
    width: widthResolver(),
    allowClear: true,
    placeholder: function(){ return $(this).data('placeholder') || 'Seçiniz'; }
  });
})();
</script>
{% endblock %}


