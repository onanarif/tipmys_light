{# templates/faculty/committee_list.html #}
{% extends 'inc/base.html' %}
{% load static %}

{% block title %}Kurul/Staj Listesi{% endblock %}

{% block content %}
<div class="container mt-4">

  {# Header + "Yeni Kurul/Staj" button for superusers #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Kurul/Staj Listesi</h2>
    {% if request.user.is_superuser %}
      <a class="btn btn-success" href="{% url 'faculty:committee_create' %}">+ Yeni Kurul/Staj</a>
    {% endif %}
  </div>

  {# Django messages (success / error) #}
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <table class="table table-bordered table-hover align-middle">
    <thead class="thead-dark">
      <tr>
        <th>Ad</th>
        <th>Aşama</th>
        <th>Başkan</th>
        <th>Başlangıç Tarihi</th>
        <th>Bitiş Tarihi</th>
        <th class="text-end">İşlemler</th>
      </tr>
    </thead>
    <tbody>
      {% for committee in committees %}
      <tr>
        <td>{{ committee.name }}</td>
        <td>{{ committee.phase.name }}</td>
        <td>
          {% if committee.chair %}
            {{ committee.chair.user.get_full_name }}
          {% else %}—{% endif %}
        </td>
        <td>{{ committee.start_date|date:"d.m.Y" }}</td>
        <td>{{ committee.end_date|date:"d.m.Y" }}</td>
        <td class="text-end">
          <a class="btn btn-sm btn-outline-info"
            href="{% url 'faculty:committee_eventlist' committee.pk %}">Takvim</a>

          <a class="btn btn-sm btn-outline-secondary"
             href="{% url 'faculty:committee_detail' committee.pk %}">Soru</a>

          <a class="btn btn-sm btn-outline-primary"
             href="{% url 'qbank:course_master_list_by_committee' committee.pk %}">Ders</a>

          {% if request.user.is_superuser %}
            <a class="btn btn-sm btn-outline-warning"
               href="{% url 'faculty:committee_update' committee.pk %}">Düzenle</a>

            {# DELETE: open confirm modal; JS will set the proper POST action #}
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              data-bs-toggle="modal"
              data-bs-target="#deleteConfirmModal"
              data-delete-url="{% url 'faculty:committee_delete' committee.pk %}"
              data-committee-name="{{ committee.name|escape }}">
              Sil
            </button>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-muted">Kayıtlı Kurul/Staj bulunmamaktadır.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {# (Optional) simple footer info #}
  <div class="small text-muted mt-2">
    Toplam Kurul/Staj: {{ total_committees }} — Bugün: {{ today|date:"d.m.Y" }}
  </div>
</div>

{# One reusable modal for all rows #}
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="deleteConfirmForm" method="post" action="#">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmLabel">Silme Onayı</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">
            <strong id="deleteItemName">Bu Kurul/Staj</strong> silinsin mi?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
          <button type="submit" class="btn btn-danger">Evet, sil</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# Important: keep this script here so it always runs #}
<script>
  (function () {
    var modal = document.getElementById('deleteConfirmModal');
    if (!modal) return;

    modal.addEventListener('show.bs.modal', function (event) {
      var trigger = event.relatedTarget;
      var url = trigger && trigger.getAttribute('data-delete-url');
      var name = trigger && trigger.getAttribute('data-committee-name');

      var form = document.getElementById('deleteConfirmForm');
      var itemName = document.getElementById('deleteItemName');

      if (url) form.setAttribute('action', url);            // ✅ post to /committees/<pk>/delete/
      if (name) itemName.textContent = '"' + name + '"';
    });
  })();
</script>
{% endblock %}

