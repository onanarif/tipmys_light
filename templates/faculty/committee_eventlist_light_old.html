{% extends "inc/base.html" %}
{% load i18n %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-2">
  <h2 class="mb-0">{{ title|default:"Committee — Events" }}</h2>

  {% if can_manage %}
    <div id="createUrls"
         data-course="{% url 'faculty:course_event_create' committee_id=committee.id %}">
      <div class="btn-group">
        <button class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
          + {% trans "Etkinlik ekle" %}
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item js-create" data-kind="course" href="#">Ders Etkinliği</a></li>
        </ul>
      </div>
    </div>
  {% endif %}
</div>

<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-sm-3">
    <label class="form-label">{% trans "Başlangıç" %}</label>
    <input type="datetime-local" class="form-control" name="start"
           value="{{ start|date:'Y-m-d\\TH:i' }}">
  </div>
  <div class="col-sm-3">
    <label class="form-label">{% trans "Bitiş" %}</label>
    <input type="datetime-local" class="form-control" name="end"
           value="{{ end|date:'Y-m-d\\TH:i' }}">
  </div>

  <div class="d-flex align-items-center gap-2 ms-auto col-sm-6 justify-content-end">
    <button class="btn btn-primary" type="submit">{% trans "Filtrele" %}</button>
    <a class="btn btn-outline-secondary"
       href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}export=csv">⬇️ CSV</a>
    <a class="btn btn-outline-secondary"
       href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}export=excel">⬇️ Excel</a>
  </div>
</form>


{% if rows %}
  <div class="mb-2">
    <strong>{{ rows|length }}</strong> {% trans "Etkinlik bulundu" %}.
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>{% trans "Tür" %}</th>
          <th>{% trans "Başlık" %}</th>
          <th>{% trans "Tarih" %}</th>
          <th>{% trans "Başlangıç" %}</th>
          <th>{% trans "Bitiş" %}</th>
          <th>{% trans "Akademisyen" %}</th>
          <th>{% trans "Anabilim Dalı" %}</th>
          <th>{% trans "Bölüm" %}</th>
          <th>{% trans "Ders Türü" %}</th>
          {% if can_manage %}<th class="text-end">{% trans "İşlem" %}</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r.Type }}</td>
            <td>{{ r.Title }}</td>
            <td>{{ r.Start|date:"d.m.Y" }}</td>
            <td>{{ r.Start|time:"H:i" }}</td>
            <td>{{ r.End|time:"H:i" }}</td>
            <td>{{ r.Lecturer }}</td>
            <td>{{ r.Department }}</td>
            <td>{{ r.DepartmentDivision }}</td>
            <td>{{ r.CourseType }}</td>
            {% if can_manage %}
            <td class="text-end">
              {% url 'faculty:course_event_edit' pk=r.EventID as edit_url %}
              {% url 'faculty:course_event_delete' pk=r.EventID as delete_url %}
              <button class="btn btn-sm btn-outline-primary js-edit" data-edit-url="{{ edit_url }}">
                {% trans "Düzelt" %}
              </button>
              <button class="btn btn-sm btn-outline-danger js-delete" data-delete-url="{{ delete_url }}">
                {% trans "Sil" %}
              </button>
            </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p class="text-muted">{% trans "Bu kurul için etkinlik bulunamadı." %}</p>
{% endif %}

<div id="modalHolder"></div>

<script>
(function(){
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                    document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1];

  function openModal(html){
    const holder = document.getElementById('modalHolder');
    holder.innerHTML = html;
    const modalEl = holder.querySelector('.modal');
    if (!modalEl) { alert('Server did not return a modal.'); holder.innerHTML = ''; return; }

    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    const form = holder.querySelector('form');
    if (form){
      form.addEventListener('submit', function(e){
        e.preventDefault();
        const url = form.getAttribute('action');
        const method = (form.getAttribute('method') || 'POST').toUpperCase();
        const formData = new FormData(form);
        fetch(url, {
          method,
          headers: { 'X-CSRFToken': csrftoken },
          body: formData,
        }).then(async r => {
          const ct = r.headers.get('content-type') || '';
          if (ct.includes('application/json')) return r.json();
          return { ok: false, html: await r.text() };
        }).then(data => {
          if (data.ok) location.reload();
          else if (data.html) openModal(data.html);
          else alert('Save failed.');
        }).catch((err) => { console.error(err); alert('Save failed.'); });
      });
    }

    const delBtn = holder.querySelector('.js-confirm-delete');
    if (delBtn){
      delBtn.addEventListener('click', function(){
        const url = delBtn.dataset.url;
        fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
        }).then(r => r.json())
         .then(data => { if (data.ok) location.reload(); else alert('Delete failed.'); })
         .catch((err) => { console.error(err); alert('Delete failed.'); });
      });
    }
  }

  // Create
  const createRoot = document.getElementById('createUrls');
  if (createRoot){
    const createUrl = createRoot.dataset.course;
    document.querySelectorAll('.js-create').forEach(el => {
      el.addEventListener('click', function(e){
        e.preventDefault();
        fetch(createUrl, { credentials: 'same-origin' })
          .then(r => r.text())
          .then(openModal)
          .catch(err => { console.error(err); alert('Open failed'); });
      });
    });
  }

  // Edit/Delete
  document.querySelectorAll('.js-edit').forEach(el => {
    el.addEventListener('click', function(e){
      e.preventDefault();
      const url = el.dataset.editUrl;
      fetch(url, { credentials: 'same-origin' })
        .then(r => r.text())
        .then(openModal)
        .catch(err => { console.error(err); alert('Open failed'); });
    });
  });

  document.querySelectorAll('.js-delete').forEach(el => {
    el.addEventListener('click', function(e){
      e.preventDefault();
      const url = el.dataset.deleteUrl;
      const html = `
        <div class="modal fade" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">{% trans "Sil" %}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <p>{% trans "Bu etkinliği silmek istediğinize emin misiniz?" %}</p>
              <button type="button" class="btn btn-danger js-confirm-delete" data-url="${url}">{% trans "Sil" %}</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "İptal" %}</button>
            </div>
          </div></div>
        </div>`;
      openModal(html);
    });
  });
})();
</script>
{% endblock %}
